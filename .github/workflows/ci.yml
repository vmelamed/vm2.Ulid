name: CI - Build, Test, Coverage & Benchmarks

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"
  workflow_dispatch:
    inputs:
      os:
        description: 'JSON array of runners'
        default: '["ubuntu-latest"]'
        required: false
      dotnet-version:
        description: 'Version of .NET SDK to use'
        default: '9.0.x'
      test-project:
        description: 'Path to test project'
        default: './test/UlidType.Tests/UlidType.Tests.csproj'
      coverage-threshold:
        description: 'Minimum acceptable code coverage percentage'
        default: '75'
      run-benchmarks:
        description: 'Whether to run benchmarks and compare against baseline'
        type: boolean
        default: true
      force-new-baseline:
        description: 'Whether to force new baseline (if true, no regression check is done)'
        type: boolean
        default: false
      benchmark-project:
        description: 'Path to benchmark project'
        default: './benchmarks/UlidType.Benchmarks/UlidType.Benchmarks.csproj'
      perf-regression-threshold:
        description: 'Maximum acceptable performance regression percentage'
        default: '10'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build
    uses: ./.github/workflows/build.yml
    if: ${{ github.event_name != 'push' || !(contains(github.event.head_commit.message, '[skip ci]') || contains(github.event.head_commit.message, '[no ci]')) }}
    with:
      dotnet-version: ${{ inputs.dotnet-version || '9.0.x' }}
      os: ${{ inputs.os || '["ubuntu-latest"]' }}

  test:
    name: Test
    needs: build
    uses: ./.github/workflows/test.yml
    with:
      dotnet-version: ${{ inputs.dotnet-version || '9.0.x' }}
      test-project: ${{ inputs.test-project || './test/UlidType.Tests/UlidType.Tests.csproj' }}
      coverage-threshold: ${{ inputs.coverage-threshold || '75' }}
      os: ${{ inputs.os || '["ubuntu-latest"]' }}

  benchmarks:
    name: Benchmarks (Linux only)
    needs: build
    if: ${{ inputs.run-benchmarks }}
    uses: ./.github/workflows/benchmarks.yml
    with:
      dotnet-version: ${{ inputs.dotnet-version || '9.0.x' }}
      benchmark-project: ${{ inputs.benchmark-project || './benchmarks/UlidType.Benchmarks/UlidType.Benchmarks.csproj' }}
      force-new-baseline: ${{ inputs.force-new-baseline || false }}
      perf-regression-threshold: ${{ inputs.perf-regression-threshold || '10' }}
